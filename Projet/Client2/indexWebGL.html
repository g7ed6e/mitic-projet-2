<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<title>WebGL Graph Démo</title>
		<script type="text/javascript" src="lib/Three.js"></script>
		<script type="text/javascript" src="lib/Stats.js"></script>
		<script type="text/javascript" src="lib/jquery-ui/js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript">
			function getImageMaterial( url )
			{
				var image = new Image();
				var material = new THREE.MeshBasicMaterial( { map : new THREE.Texture( image ) } );
				with ( { material : material } )
				{
	    			image.onload = function()
		    		{
		        		this.loaded = true;
	    	    		material.map.image = this;
	    			};
				}
				image.src = url;
				return material;
			}
		
			var lineMaterial =  new THREE.LineBasicMaterial({
			    color: 0xFF0000,
			    opacity: 0.7,
			    blending: THREE.AdditiveBlending,
			    transparent: true,
			    linewidth: 1
			} );
			
			var container, stats;
			var camera, scene, renderer, group, particle;
			var mouseX = 0, mouseY = 0;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			
			function init() {

				//container = document.createElement( 'div' );
				//document.body.appendChild( container );
				$('body').append("<div id='container'></div>");
				
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 3000 );
				camera.position.z = 100;

				scene = new THREE.Scene();
				scene.add( camera );

				var PI2 = Math.PI * 2;
				var program = function ( context ) {
					context.beginPath();
					context.arc( 0, 0, 1, 0, PI2, true );
					context.closePath();
					context.fill();
				}

				group = new THREE.Object3D();
				scene.add( group );

				$.ajax({
					  url: '../Server/index.php',
					  dataType: 'json',
					  cache: false,
					  data:  {"controller" : "score", "id" : 1, "nn" : 20, "action" : "getScoreV2", "w": window.innerWidth / 4, "h": window.innerHeight / 4, "s": "0" },
					  success: function(data) {
							var liens = data.liens;
							var positions = data.positions;	
							// itération sur les liens
							for(var i in liens){
								// recherche du premier point
								var found = false;// flag pour optimiser ces 3 affreuses boucles imbriquées dues au format choisi à l'origine du projet
								for (var j in positions){
									if (liens[i][0] == positions[j][0]){
										for (var k in positions){
											if (liens[i][1] == positions[k][0]){ 
												var geom = new THREE.Geometry();
												geom.vertices.push( new THREE.Vertex( new THREE.Vector3(positions[j][1], positions[j][2], 0) ));
												geom.vertices.push( new THREE.Vertex( new THREE.Vector3(positions[k][1], positions[k][2], 0) ));
												var o = new THREE.Line(geom, lineMaterial);
												group.add(o);
												found = true;
												break;
											}
										}
									}
									if (found)break;
								}
							}
					      for(var i in positions){
					    	  var o = new THREE.Object3D();
					    	  var id = positions[i][0];
					    	  var imageUrl = "../Server/index.php?controller=image&action=getImg&id="+id+"&t=50";
					    	  var cube = new THREE.Mesh(
					    				new THREE.CubeGeometry( 8, 8, 0.1 ),
					    				//new THREE.MeshLambertMaterial( { color: 0xFF0000 } )
					    				//new THREE.MeshBasicMaterial( { map : getMaterial( path ) } )
					    				getImageMaterial( imageUrl )
									);
					    	  o.add(cube);
					    	  o.position = new THREE.Vector3(positions[i][1], positions[i][2], 0);
							  group.add(o);  
					      }
					    	  
							
					  }
				});	
				
				renderer = new THREE.CanvasRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				
				var html5logo = new Image();
				html5logo.src = "Ressources/Images/HTML5_Logo_64.png";
				var jQuerylogo = new Image();
				jQuerylogo.src = "Ressources/Images/jquery12.gif";
				var webGLlogo = new Image();
				webGLlogo.src = "Ressources/Images/webgl-logo.png";
				$("#container").append(renderer.domElement).append(stats.domElement).append("<div id='logos'></div>");
				$("#logos").append(webGLlogo).append(html5logo).append(jQuerylogo);
			}

			function animate() {
				requestAnimationFrame( animate );
				render();
				stats.update();
			}

			function render() {
 				camera.position.x += ( mouseX - camera.position.x ) * 0.02;
 				camera.position.y += ( - mouseY - camera.position.y ) * 0.02;
				camera.lookAt( scene.position );
 				//group.rotation.x += 0.01;
 				//group.rotation.y += 0.02;
				renderer.render( scene, camera );
			}	
			$(document).ready(function(){
				init();
				animate();
				$(document).bind('mousemove', function ( event ) {
					mouseX = event.clientX - windowHalfX;
					mouseY = event.clientY - windowHalfY;
// 					console.log(mouseX);
// 					console.log(mouseY);
				});
				
// 				.('touchstart', function ( event ) {
// 					if ( event.touches.length == 1 ) {
// 						event.preventDefault();
// 						mouseX = event.touches[ 0 ].pageX - windowHalfX;
// 						mouseY = event.touches[ 0 ].pageY - windowHalfY;
// 					}
// 				}).('touchmove', function ( event ) {
// 					if ( event.touches.length == 1 ) {
// 						event.preventDefault();
// 						mouseX = event.touches[ 0 ].pageX - windowHalfX;
// 						mouseY = event.touches[ 0 ].pageY - windowHalfY;
// 					}
// 				});
			});
		</script>
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
			a {
				color:#0078ff;
			}
			#logos {
				position: absolute;
				top: 0px;
				right: 20px;
			}
		</style>
	</head>
	<body>
	</body>
</html>	